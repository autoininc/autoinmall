<!DOCTYPE html>
<html lang="en">

<head>
	<title>AUTOINMall</title>
	<%- include('head') %>
	<link href="/css/index.css" rel="stylesheet">
	<style>
		#mainNav {
			background-color: #212529;
		}

		td .btn {
			margin-left: 20%;
			margin-right: 20%;
			width: 60%;
			padding-left: 5%;
			padding-right: 5%;
		}

		.dropdown-menu {
			background-color: #212529;
		}

		.dropdown-item {
			color: white !important;
		}

		.dropdown-item:hover {
			background-color: silver !important;
		}

		.brand-card {
			text-align: center;
			margin-bottom: 1%;
		}

		.brand-card a {
			color: black !important;

		}

		.brand-card img {
			width: 30%;

		}
	</style>
</head>

<body id="page-top">
	<%- include('body_nav') %>
	<div class="container" style="margin-top:10%;margin-bottom:5%;border:silver solid 1px;padding:1% 1% 1% 1%">
		<h3 style="border-bottom:#212529 solid 1px">&nbsp;&nbsp;Order</h3>
		<div class="card card-outline-secondary my-4">
			<div class="card-body item-card">
				<div class="table-responsive" id="table_view">
					<table class="table table-bordered table-striped">
						<thead>
						<tr>
							<th scope="col">#</th>
							<th scope="col">Item</th>
							<th scope="col">Parts Number</th>
							<th scope="col">Quantity</th>
							<th scope="col">Price</th>
						</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>

		</div>
		<h3 style="border-bottom:#212529 solid 1px">&nbsp;&nbsp;Destination</h3>
		<div class="card card-outline-secondary my-4">
			<div class="card-body item-card">
				<div class="input-group mb-1">
					<div class="input-group-prepend">
						<span class="input-group-text" style="width:120px;">ZIPCODE</span></div>
					<input class="form-control" disabled id="zipcode" name="zipcode" type="text">
				</div>
				<div class="input-group mb-1">
					<div class="input-group-prepend">
						<span class="input-group-text" style="width:120px;">ADDRESS</span></div>
					<input class="form-control" disabled id="address" name="address" type="text">
				</div>
				<div style="float:right">
					<input class="btn btn-secondary" id="change_dest" type="button" value="change">
				</div>
			</div>
		</div>
		<h3 style="border-bottom:#212529 solid 1px">&nbsp;&nbsp;Contact</h3>
		<div class="card card-outline-secondary my-4">
			<div class="card-body item-card">
				<div class="input-group mb-1">
					<div class="input-group-prepend">
						<span class="input-group-text" style="width:120px;">Email</span></div>
					<input class="form-control" disabled id="email" name="email" type="text">
				</div>
				<div style="float:right">
					<input class="btn btn-secondary" id="change_contact" type="button" value="change">
				</div>
			</div>
		</div>
		<div style="text-align: center;">
			<input class="btn btn-primary mt-2 mb-2" id="payment" style="font-size:25px" type="button" value="Payment">
		</div>
	</div>

	<!-- Footer-->
	<%- include('footer') %>

	<!-- hidden -->
	<input type="hidden" id="e_username" value="<%= username %>" />

	<!-- Core theme JS-->
	<script src="/js/nav.js"></script>

	<!-- iamport.payment.js -->
	<script src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js" type="text/javascript"></script>
	<script src="/js/paypal.js"></script>

	<script>
		var username = '<%- username %>';
		var cart = JSON.parse('<%- cart %>');
		var email = '<%- email %>';
		var dest = JSON.parse('<%- dest %>');
		var name_list = "";//list of items
		var cost;
		$("#zipcode").val(dest[0].ZIPCODE);
		$("#address").val(dest[0].ADDRESS);
		$("#email").val(email);

		//change destination
		$("#change_dest").off("click").on("click", function () {
			if ($("#change_dest").val() === "change") {
				$("#change_dest").val("finish");
				$("#change_dest").css("background-color", "red");
				$("#zipcode").attr("disabled", false);
				$("#address").attr("disabled", false);

			} else {
				$("#change_dest").val("change");
				$("#change_dest").css("background-color", "gray");
				$("#zipcode").attr("disabled", true);
				$("#address").attr("disabled", true);
			}
		})
		//change contact
		$("#change_contact").off("click").on("click", function () {
			if ($("#change_contact").val() === "change") {
				$("#change_contact").val("finish");
				$("#change_contact").css("background-color", "red");
				$("#email").attr("disabled", false);
			} else {
				$("#change_contact").val("change");
				$("#change_contact").css("background-color", "gray");
				$("#email").attr("disabled", true);
			}
		})

		if (cart) {
			var length = cart.length;
			var total = 0.0;
			for (var i = 0; i < length; i++) {
				{
					$("tbody").append(
						'<tr id="temp">' +
						'<th scope="row">' + (i + 1) + '</th>' +
						'<td><a href="/item/info?pin=' + cart[i].PIN + '" style="color:black;,text-decoration: none;">' + cart[i].ITEM + '</a></td>' +
						'<td>' + cart[i].PARTS_NUM + '</td>' +
						'<td>' + cart[i].VOLUME + '</td>' +
						'<td>' + cart[i].PRICE + '</td> ' +

						'</tr>'
					)
				}

				if (!isNaN(cart[i].PRICE)) {
					total = parseFloat(total) + parseFloat(Number(cart[i].PRICE));
				}

				$("#temp").attr("id", i);
				$("#temp_btn").attr("id", "no." + String(i));
				if (i === 0) {
					name_list = cart[i].ITEM + "\n" + cart[i].PIN + "\n";
				} else {
					name_list = name_list + name_list + cart[i].ITEM + "\n" + cart[i].PIN + "\n";
				}

				//
			}
			$("tbody").append(
				'<tr>' +
				'<th scope="row" colspan="4">TOTAL</th>' +
				'<td colspan="2">$ ' + total.toFixed(2) + '</td> ' +
				'<tr>'
			)
			cost = total.toFixed(2);

		}


		$("#payment").off("click").on("click", function () {
			if ($("#zipcode").val() && $("#address").val()) {
				var name = name_list.replace(/\\r/gi, '').replace(/\\n/gi, '<br>').replace(/\\t/gi, '_&nbsp;').replace(/\\f/gi, ' ');
				var data = {
					name: username,
					email: $("#email").val(),
					zipcode: $("#zipcode").val(),
					address: $("#address").val(),
					name: name,
					total: cost,

				}
				paypal(JSON.stringify(data));
			} else {
				Swal.fire({
					title: "error",
					icon: "error",
					text: "Please check your Address or Zipcode"
				})
			}

		})
	</script>
</body>

</html>
