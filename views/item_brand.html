<!DOCTYPE html>
<html lang="en">

<head>
	<%- include('head') %>
	<link href="/css/index.css" rel="stylesheet">
</head>

<body>
	<form>
		<div class="input-group mb-1">
			<span class="input-group-text">Name</span>
			<input class="form-control" id="name" name="name" type="text">
			<span class="input-group-text">Img</span>
			<div class="form-control-upload filebox">
				<label for="img">사진 업로드</label>
				<input type="file" display="none" class="filebox" accept="image/*" id="img" name="brandimg" />
				<input type="text" class="upload-name-img" readonly="readonly" disabled="disabled" />
			</div>

		</div>
		<div class="input-group mb-1">
			<span class="input-group-text">City</span>
			<input class="form-control" id="city" name="city" type="text">
			<span class="input-group-text">Country</span>
			<input class="form-control" id="country" name="country" type="text">
			<input class="btn btn-secondary" id="add-btn" type="button" value="add">
		</div>
	</form>
	<table class="table">
		<thead class="thead-dark">
		<tr>
			<th scope="col">NAME</th>
			<th scope="col">CITY</th>
			<th scope="col">COUNTRY</th>
			<th scope="col">IMG</th>
			<th></th>
			<th></th>
		</tr>
		</thead>
		<tbody></tbody>
	</table>

	<script>
		var data = JSON.parse('<%- data %>');
		for (var i = 0; i < data.length; i++) {
			$("tbody").append(
				'<tr>' +
				'<td><input type="text" id="name' + i + '" disabled value="' + data[i].NAME + '" style="border:none;background-color:white"</td>' +
				'<td><input type="text" id="city' + i + '" disabled value="' + data[i].CITY + '" style="border:none;background-color:white"</td>' +
				'<td><input type="text" id="country' + i + '" disabled value="' + data[i].COUNTRY + '" style="border:none;background-color:white"</td>' +
				'<td><input type="text" id="img' + i + '" disabled value="' + data[i].IMG + '" style="border:none;background-color:white"</td>' +
				'<td><input type="button" id="setting' + i + '" class="btn btn-secondary" value="edit" onclick="set_item(' + i + ');"></td>' +
				'<td><input type = "button" class = "btn btn-danger" value = "delete" onclick="del_item(' + i + ');"></td>' +
				'</tr>'
			)
		}

		//setting item brand
		function set_item(i) {

			if ($("#setting" + i).val() === "edit") {

				$("#city" + i).attr("disabled", false);
				$("#city" + i).css("border", "1px solid black");
				$("#country" + i).attr("disabled", false);
				$("#country" + i).css("border", "1px solid black");
				$("#img" + i).attr("disabled", false);
				$("#img" + i).attr("type", "file");
				$("#img" + i).css("border", "1px solid black");
				$("#setting" + i).val("finish");
				$("#setting" + i).css("background-color", "#28a745");
			} else if ($("#setting" + i).val() === "finish") {

				$("#city" + i).attr("disabled", true);
				$("#city" + i).css("border", "none");
				$("#country" + i).attr("disabled", true);
				$("#country" + i).css("border", "none");
				$("#img" + i).attr("disabled", true);
				$("#img" + i).css("border", "none");
				$("#setting" + i).val("edit");
				const formdata = new FormData();
				formdata.append("name", $("#name" + i).val());
				formdata.append("city", $("#city" + i).val());
				formdata.append("country", $("#country" + i).val());
				formdata.append("img", $("#img" + i)[0].files[0]);
				formdata.append("id", data[i].ID);

				$.ajax({
					url: "/admin/itembrand/change",
					type: "post",
					data: formdata,
					contentType: false,
					processData: false,
					success: function (data) {

						location.reload();
					},
					error: function () {
						alert("fail");
					}
				})


			} else {
				alert("인식못함");
			}
		}

		$(document).ready(function () {
			var imgTarget = $("#img");
			imgTarget.on("change", function(){ // 값이 변경되면
				console.log($(this)[0].files[0].name);
				if(window.FileReader) { // modern browser
					var imgname = $(this)[0].files[0].name;
				}
				else { // old IE
					var imgname = $(this).val().split('/').pop().split('\\').pop(); // 파일명만 추출
				} // 추출한 파일명 삽입
				$(this).siblings(".upload-name-img").val(imgname);
    	});
		});

		//delete item brand
		function del_item(i) {
			var name = data[i].NAME;

			$.ajax({
				url: '/admin/itembrand/delete',
				type: 'post',
				data: {
					name: name,
					img: data[i].IMG
				},
				success: function () {
					location.reload();
				},
				error: function () {
					location.reload();
				}
			})
		}

		//add item brand
		$("#add-btn").off("click").on("click", function () {
			const formdata = new FormData($("form")[0]);
			$.ajax({
				url: "/admin/itembrand/add",
				type: "post",
				contentType: false,
				processData: false,
				data: formdata,
				success: function (data) {
					if (data === 'fail') {
						alert("overlap item brand and country");
					}
					location.reload();
				},
				error: function () {
					location.reload();
				}
			})
		})

	</script>

</body>

</html>
